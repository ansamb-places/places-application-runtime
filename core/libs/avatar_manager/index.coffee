###
	Places, Copyright 2014 Ansamb.
	
	This file is part of Places By Ansamb.
	
	Places By Ansamb is free software: you can redistribute it and/or modify it
	under the terms of the Affero GNU General Public License as published by the
	Free Software Foundation, either version 3 of the License, or (at your
	option) any later version.
	
	Places By Ansamb is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
	or FITNESS FOR A PARTICULAR PURPOSE. See the Affero GNU General Public
	License for more details.
	
	You should have received a copy of the Affero GNU General Public License
	along with Places By Ansamb. If not, see <http://www.gnu.org/licenses/>.

###
fs = require 'fs'
path = require 'path'
avatar_dir = '_avatars'
async = require 'async'
default_avatar = path.resolve(__dirname,'./defaults/default_avatar.png')
default_base64 = 'iVBORw0KGgoAAAANSUhEUgAAAKYAAACmCAIAAADf6mMgAAAKwWlDQ1BJQ0MgUHJvZmlsZQAASA2tlndUU8kXx+e9l15ogdAh9N47SK8BFaSDqIQkkFBiCAQBUVFZXMGKiAioKyqCKLgWQBYVEcWKgmLXBVlU1HWxICoqvxdY4p7f+e1/vzlnZj7vO/fed2fOzDkXAEonSyhMh+UAyBBki8IDfRixcfEM/BOAAHVABjQAsdhZQu+wsLngX9vHOwCSLN6ykMT6V7P/vSDP4WaxAYDC0OUkThY7A+UTaK9jC0XZACAJqK63LFso4UKUFUVogiiXSzhlhuslnDTDHdM2keG+qM1NAAgUFkuUAgD5EaozctgpaBzyV5StBRy+AACKOcoebB6Lg7Ikd/OMjKUSrkTZOOkfcVL+wSxWkjQmi5Ui5Zm9oJ7oj/34WcJ0Vt70x/9zyEgXo+c13XTQkcITBYWjMwk9s5q0pSFSFiTND53V+eiOZpknDoqaZXaWL3qWM74cll/ILIvTorxnmSVC6W8bfjYzcpZFS8Ol8QXp8yX3YzoHHpcpZW6Wf8SsnswPYM5yPi8yZpZz+NHzZzkrLUKaQz7PV6qLxOHSnJNFAdI9ZmShnn//l8368a9sXmTQrM7h+vnPMlcQJc1HmO0jjSNMn77f0/lz0wOlelZOhNQ3WxQp1VNZwZL7Om0vzA6TngmwBfbAAVgDdHfZ3Fz0rgHgu1SYJ+Kn8LIZ3ujr4DKYAralOcPW2sYeAMlbk9gA8J4+/YYg+pUfWm4SAO5pAMBBP7TYWACajQFQjf2hGaoDQEPfTetGtliUMxMPI5mwaIayQBGoAi2gB4yBBZqfI3ADXsAfBINQEAniwGLABjyQAURgGSgAq0ExKAVbwHZQBfaAfaAeHAHHQCvoAOfARXAV3AQD4CEYBCPgFRgDH8EkBEF4iArRIFVIGzKAzCBbyBnygPyhuVA4FAclQimQABJDBdBaqBQqg6qgvVAD9Ct0CjoHXYb6oPvQEDQKvYO+wAhMgRVhTdgQtoKdYW84BI6EF8EpcCacDxfBm+BKuBY+DLfA5+Cr8AA8CL+CxxGAkBE6ooNYIM6ILxKKxCPJiAhZiZQgFUgt0oS0Iz3ILWQQeY18xuAwNAwDY4FxwwRhojBsTCZmJWYDpgpTj2nBdGNuYYYwY5jvWCpWA2uGdcUysbHYFOwybDG2AluHPYm9gB3AjmA/4nA4Os4I54QLwsXhUnHLcRtwu3DNuE5cH24YN47H41XxZnh3fCiehc/GF+N34g/jz+L78SP4TwQyQZtgSwggxBMEhDWECsIhwhlCP+E5YZIoRzQguhJDiRxiHnEzcT+xnXiDOEKcJMmTjEjupEhSKmk1qZLURLpAekR6TyaTdcku5AVkPrmQXEk+Sr5EHiJ/pihQTCm+lASKmLKJcpDSSblPeU+lUg2pXtR4ajZ1E7WBep76hPpJhiZjKcOU4ciskqmWaZHpl3kjS5Q1kPWWXSybL1she1z2huxrOaKcoZyvHEtupVy13Cm5u3Lj8jR5G/lQ+Qz5DfKH5C/Lv1DAKxgq+CtwFIoU9imcVximITQ9mi+NTVtL20+7QBtRxCkaKTIVUxVLFY8o9iqOKSko2StFK+UqVSudVhqkI3RDOpOeTt9MP0a/Q/+irKnsrcxVXq/cpNyvPKGiruKlwlUpUWlWGVD5ospQ9VdNU92q2qr6WA2jZqq2QG2Z2m61C2qv1RXV3dTZ6iXqx9QfaMAaphrhGss19mlc0xjX1NIM1BRq7tQ8r/lai67lpZWqVa51RmtUm6btoc3XLtc+q/2SocTwZqQzKhndjDEdDZ0gHbHOXp1enUldI90o3TW6zbqP9Uh6znrJeuV6XXpj+tr68/QL9Bv1HxgQDZwNeAY7DHoMJgyNDGMM1xm2Gr4wUjFiGuUbNRo9MqYaexpnGtca3zbBmTibpJnsMrlpCps6mPJMq01vmMFmjmZ8s11mfeZYcxdzgXmt+V0LioW3RY5Fo8WQJd1yruUay1bLN1b6VvFWW616rL5bO1inW++3fmijYBNss8am3eadrakt27ba9rYd1S7AbpVdm91bezN7rv1u+3sONId5Duscuhy+OTo5ihybHEed9J0SnWqc7jorOoc5b3C+5IJ18XFZ5dLh8tnV0TXb9ZjrX24Wbmluh9xezDGaw52zf86wu647y32v+6AHwyPR4xePQU8dT5ZnredTLz0vjled13NvE+9U78Peb3ysfUQ+J30mfF19V/h2+iF+gX4lfr3+Cv5R/lX+TwJ0A1ICGgPGAh0Clwd2BmGDQoK2Bt1lajLZzAbmWLBT8Irg7hBKSERIVcjTuaZzRXPb58Hzgudtm/dovsF8wfzWUBDKDN0W+jjMKCwz7LcFuAVhC6oXPAu3CS8I74mgRSyJOBTxMdIncnPkwyjjKHFUV7RsdEJ0Q/REjF9MWcxgrFXsitircWpx/Li2eHx8dHxd/PhC/4XbF44kOCQUJ9xZZLQod9HlxWqL0xefXiK7hLXkeCI2MSbxUOJXViirljWexEyqSRpj+7J3sF9xvDjlnFGuO7eM+zzZPbks+UWKe8q2lFGeJ6+C95rvy6/iv00NSt2TOpEWmnYwbSo9Jr05g5CRmHFKoCBIE3Qv1Vqau7RPaCYsFg5mumZuzxwThYjqsqCsRVlt2YpoUXNNbCz+STyU45FTnfNpWfSy47nyuYLca3mmeevznucH5B9YjlnOXt5VoFOwumBohfeKvSuhlUkru1bprSpaNVIYWFi/mrQ6bfX1NdZrytZ8WBuztr1Is6iwaPinwJ8ai2WKRcV317mt2/Mz5mf+z73r7dbvXP+9hFNypdS6tKL06wb2hisbbTZWbpzalLypd7Pj5t1bcFsEW+5s9dxaXyZfll82vG3etpZyRnlJ+YftS7ZfrrCv2LODtEO8Y7BybmXbTv2dW3Z+reJVDVT7VDfXaNSsr5nYxdnVv9trd9MezT2le778wv/l3t7AvS21hrUV+3D7cvY92x+9v+eA84GGOrW60rpvBwUHB+vD67sbnBoaDmkc2twIN4obRw8nHL55xO9IW5NF095menPpUXBUfPTlr4m/3jkWcqzruPPxphMGJ2pO0k6WtEAteS1jrbzWwba4tr5Twae62t3aT/5m+dvBDp2O6tNKpzefIZ0pOjN1Nv/seKew8/W5lHPDXUu6Hp6PPX+7e0F374WQC5cuBlw83+Pdc/aS+6WOy66XT11xvtJ61fFqyzWHayevO1w/2evY23LD6UbbTZeb7X1z+s70e/afu+V36+Jt5u2rA/MH+u5E3bl3N+Hu4D3OvRf30++/fZDzYPJh4SPso5LHco8rnmg8qf3d5PfmQcfB00N+Q9eeRjx9OMwefvVH1h9fR4qeUZ9VPNd+3vDC9kXHaMDozZcLX468Er6afF38p/yfNW+M35z4y+uva2OxYyNvRW+n3m14r/r+4Af7D13jYeNPPmZ8nJwo+aT6qf6z8+eeLzFfnk8u+4r/WvnN5Fv795Dvj6YypqaELBFruhZA0BFOTgbg3UEAqHForYDWxSSZmVp42gKaqd9RltTxki5p/8Uz9fL0iiMABzoBiCoEIAidq9HZEJ0VvACQlEWRXgC2s5N2VJG0rGQ722mAKCK0NPk0NfVeEwB8OwDfRFNTk7umpr7tR2v2+wB0Zs7U4BJr7DAA+mhQ4sT1N+s7p/3/MfwHeJT8yh6LRuwAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAGdaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIj4KICAgICAgICAgPGV4aWY6UGl4ZWxYRGltZW5zaW9uPjE2NjwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlBpeGVsWURpbWVuc2lvbj4xNjY8L2V4aWY6UGl4ZWxZRGltZW5zaW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KEs5fFwAAD6JJREFUeAHtnXtsHMUZwH139t3ZvvPdJefENiYYP/IwlFAooEASkxADlfoiFRISfVEigSoViVZQCAUqKLQhtBQipIqqaovaquKPitJStSQQDLRACQkJAafOi4Y8HD/i2Bfb53v22529ufXd3t3u7Oze7t23Xp1nZ2fm++b7zTePfdw50ul0DW7VZIFaUtk9z94/+PtX8iuejqfi00mny1Hrc4V6A9c+dJ2rXsqSnxhjbGEBid/c9PTcmbiixo50TSqZnptIDP9r/J/3vLzh8b66hjrFlBhpCws4S2qZdghJADxsE/umd2weiM8oNw4hBW6Wt0Bp5FCFfOqJKFK3PNsCCqpCnk99+30DSL2ASa0erRa5AvX7kbrV6SrqpwF5LvW909uRuqJRrR2pDTlStzZNVdppRp5PfcfmN5LRhCppmMgCFmBBnkP9zAfntm8eQOoWoKlKBQl5IjKrKrkskXzlhtRlhrF6UEI+eWSEXGzRpC9S12QuiySWkNc2ukEhNuoAnmQUfP0B7OEtQragGhLyYFcLcdmCCYueyFLfg9SLWsoCJyXkjYtCoAwhx+DrNC8EzgD1Hw6kYkkL1A5VULCAhHzZl1YHltfDeT2+DtmlHn73uVc2v47UFextgSgJucNd2/9EX9MyiTqQY/B10lwodRjXkboFEOeqICGHaLfP078lSx1idFIffz+C1HPtbYHjLHJQxtMkUl+a7eGRugUYcVZhHnKJOvTwSJ2znS1UXC5yo6jDHD6Oc3hLgFdATqn7l3ohLJ+UaVJZnnF8lziuI3VNFjQmsTJykEXGdb7Ud8AcHqkbA1J9qQWRQxHegBfm8P4ebr4+tiuC1NWzMShlMeQS9Sd4U8dx3SCY6ootgdwQ6u9FdiB1dXiMSFUaeZZ6N78eHqg/OJBK4BzeCKYlynSQd9ISkdeSUzuLp42ejW6/dyByKArJyCUahgvy8ozeBa5Ar18uFN6SSEaT8dlkcjaViqVSiXQ6KQgJLPfJk5UM0/fsWi9t7t3YWzK9YoJ7f3bybER8XJ8WNz9dav5h9kh8zQPe6vK4XQ0eZzjk7mjzrOj0Xtxjibd8NLxg5g164To8oQ4cAB7sWqnLM0bPJOfePJu1lBhSLHB2NDdZTq5Chx6fhgrmFPLR4bMjEzM5kXoOA42engsC13w2eNN1TY3CFc7ybKo6dqoaoe7v4tbDE8AO6GscQutR5E2l2z0wOT236+ORp/8wdMOdH9z9xIl9Q+V540cbcjC6QH1rH1/qAJx0+KTn4PLJs304oE8TduiwFXdytsin0NOTQkS15mKJt/ac2vSjfXc+8r+ho2Y/HKwZeYb6Wr7UYcB2CvaUfJ06PVtANCzXDxjOhZ6oRnGHU8V3yCUkgC3TesSI9PuDo7c9tO+x50ZiJnJnQQ7qeoP1/VvX+js9gupChfTeaU1Br04KEgqr0I22DKhfxuljidSLO4/des/QgSMmYWdEDjoL1J/s40KdELYacbElG9P4CHuBuyTkk+GpOx7Z/7c3eM4WC6nOjpxS93Xqms1RzchwTg/5BMTelE9R3EuB9TGwz7j7zFzisecOPP/SFHc5OQXqQg5lga9fv3UtM3XALB8XrOboOcYy5JCO8TU1iWRq258O/u4vk4YIyhSqFzmU4w0xUkfeEgUZdZjR/PKFw399fToDiP9/Dsiz1C/UMJtD3vNgyqgnUqktvzm4/6BRq3Y+yCXqT/b5OlRRR97zeJMDGXVYuD+87Ug0ppBKfxQ35KAK9PD9W9YATtjkI3SOlsg7xyDZQxn1Y6ORx587nT3FL8QTOWjlCQmz9yLUkXcJdjLq2985sfe//D2dM3Koj+TfmUtptAWQgNz7LT4/p4vmEpC4nybUxQn8U8+f4F48f+SgIrCESww5vl4W/ya3hrlbzYwCxas0Hx0Zf/sD4W41x80Q5AJdUUdKHRqBVv+GvMw7//6DXDBh/tRKLOPokO+3L41ozV08Pfvt5OLlAi/4gzsl4O4pweeFjbYAcpj/KU/AH1u+PJUxMgAqc+QmE11WurOSe67wMeRKp/cNjQ2PtbeEuTknt4IUFYc7JfIbo5CmCEg5b8XSbBwJjQZ20kmorEamncEluT/vYHxCRFEUfy8n5EAYRQgBGlZUQp6YJGhc4mlbFV60IuxdWO+qVWqXxG/yi5M6FOlEfZOwgmDbtn6/JxYXeivFzVkgnuoVjaVPjcbf23/unb2jZyLieEypZ3Aqlpwf+fbeie/csiA/ni2GP3LQg7oyCdDDQirKG0Rtg+Mzm3p6v7Ki7DdElnfqN477C32N0djinz8/+uJrx4S5JKFeyBD58WLffuT4FNxQd+tXRyxfyYHyBRsfQ5pFXcC5/qmrV1iAN8cae901mzc13/ftZU6naG311DOdQSyRfGu35q/sKlSF8iMnLg76QU+56r5Lwz3hQrraOn7jBt/N/Rdkq0AHgGxUsdDQUW5LNQORl+zPaRVJysVrg+1XnU8jKy9w9zfCi0MNQr0y7qu+jp+enlOfuHhKo5DTKVtx8fKzy77YLT+svLDLmb72ykVs9RqdsDxyqJgaL6e9urPOcd5lbWzmsFGu1ZfNe1VDvebRKLc3ezh7uSOl+aFF0jJgoi4sWyt962hjfGElxu9L1Tgjhx/eIdTUuLicr8NV+byhvqEAo8HjiYKvQ8nNqCbMqIGaojGNNS2AyE3lwj528bsyxRm5q46xQKeXMaOpxCpCGG9DszZjl9dVEfa0QSV4I89Uma6+MhH43yoWMAq5VeqHeuRZAJHnmaTSIxB5pRPOqx8izzNJpUeUGbnWi3R2x8G6oJEeH+VSfd7ImevEpTZYiAoL8EauQqRyEu23kJXLwdhSFrAM8lKK4nleFkDkvCxpm3IQuW1Q8VIUkfOypG3KQeS2QcVL0TIjr7a7L07WRWzmxU4O3Hkjr4rHmTjYvYxF8EbOXBV+T30wq1AlGS2DvErsbYFqInILQDBXBURurr0tIA2RWwCCuSogcnPtbQFpiNxUCNKvS2iXyXFBwxl52b4rTbsRqzYHZ+TsduTYjNmVqIqclkFeFda2RCURuSUwmKkEIjfT2paQhcgtgcFMJRC5mda2hCxEbioG9vvl/FY0vJHj/XJTmxCLMN7IWXQQ8vBrxKwaVE0+qyCvGoOXv6KIvPwMTNYAkZts8PKLQ+TlZ2CyBojcZIOXXxwiN5WBwwL25qwCvjJsagtiEsYZOZMOYiZcmLPbTltOyyDXpjamZrcAIme3nU1zInKbgmNXG5Gz286mORG5TcGxq43I2W3HkDOdYlyZcPyJZkTOAM7eWayCnOO3JNgbiPHaWwW58TVFCZIFEHnVNQVEjsirzgJVV2H0ckRedRaougrz93J8kt3ijYg/csYKM16VYpRWzdkMQM5WJLdfcbU4TcZOkOPXc7DxKWZWl1dbrcjXuMam4sUKrZRzx4cZf4bczfrLovmW449c06+X0p/TSUTSkZNT+fpVWMzuwVm2Gnnc3H4glD9yd1D4VXZgqfVbmA+/epTNHDbK9eq7E2za+hsZf+s+Xxx/5I2tnnwxamIOvfhpfKaSu/f9B+P/+XBEMIX2r+huXcRo1XzL80fub23MF1MkhvYHsYnkm1v+XSSlrU+dm0k/vO1IIiVMU4Wb3xof/+5o9fKqPn/kzcsXMihHRoHhN8++/ugbqTjjHIdBrjlZTpxO3v7QoWOjEUEcTL61e/kVFzXwUrWWV0G0nLbPnedwfpgWF10Akk7QaIL8AHV0OHVy58RLB1/pvaWre0OXk9+cJV+oOTEnR1J//PvEywPHz0XFMYvAVunikFhMucDvXdHFbSznj9zT5GlaVj85OCsHWdK+NDEEZo7Hdj05uGfbAV9XvTdU53CWXvUVsmF4aXDl11aWlK6Y4MFnhk+NRxVOFbpqND8+lkhNnoudGp/OPsOkibdMcG93SHakN8gfOWi05JqWDwc1T78BNmy0Y0jOpSc/npnUV0E974AdODr1yTC/dSMrbzDA51fzRM5/LAcVu2/scWTaktalGqEOuRgy6msexuQG0mSHjqhQX6QoGXKJ6Rf6vddfrW1GrFgejTQEef2C+rZrF4AM4rhUmJoAZCE7JCbgGT7VCNKQRvx+Zei2hZ6bIlQZIKQ1wZ6v2Q1rWonk+dHsR4YgB3UuueVi2qmy+StlzxDISpw/vmqzk2wKAUGyC56nadcmMpM64+I+b92mjYLzcNyMQh7qDLWtzzp6lgFH3Su1KOCd2b68vt3fmD3MROv6bxRyUOrKOy6v9Qvqgpvips0C4kDQFvZ999awtowqUhuIvH5hw8Xf7KY6oKNTUxQJCAORyLvW6fzetzpcTj0jk7IcA5GDwN6NvS1rg0ItREdH6soQaKzswtxNG5b0Xc7tIiuVAAFjkYOA1fes8l0g3BJA6nK7K4TJEC66+Mql4R/c3qyQhkeU4cjdje71j1/jbRbW6fai7hQm6WZtMt497YFn7u9gfmGxpMaGIwcNfK3+dT+92hO2H/WS5uOQAGDDThZ+NTWdrYFtD3Q1GNKjS8qagRxEhS4MXf/0moYlbgiDr8MO4zoO7QJswSLSHO2izoW//nH3wqCxUIwtXahPZvO3Nt34i3XNVzWRCNrJVyl44txgC8Lb4bhxVfuvHrnQ12D4aGIecqidN+jt/8m63ts6nG6hYsTdIVBFHk9IU+cWeQcbPQ9sWv7oXS113J5vA6MW3DJ3Pwom4H/i0q+v7FzX8e6zu0ffFe5TEXeHAIAnHb48EsK23whgWo1MNw4RTqfzuitb771tcbDJPN8rA3KoalN7ANz9xHvH978wNP6++KxIhj3t8KmJyhaQDzk52LTqJMNMsta6nKsuWbzpq4t6+T37oFKp8iAnyp13RTvsY0Njh/5x+MRbY3NjCao0dX0aU85AHjA9yixZ7F99efjm/lB7i3meLVe4nMiJHuGlYdgdd9WcHhw5uevU+NDE9PHozKlYKsb/WqO85qaF/Q3ulgX1rc0NlyzzrbnM13m+KSN24eo5yGM6ichryamdhZOZfQZmd7NnZ+EZ59h0LNfHCkxpFaM9Pg9cFWDT/tCxRHQut9kV6uDz4+tczkCTAwZpd/ndap4BLKZORjewtDdYD3smogz/u5dY1Dg6bVGe4USn0phdjwUQuR7r2TIvIrclNj1KI3I91rNlXkRuS2x6lEbkeqxny7yI3JbY9CiNyPVYz5Z5EbktselRGpHrsZ4t8yJyW2LTozQi12M9W+ZF5LbEpkdpRK7HerbMi8htiU2P0ohcj/VsmReR2xKbHqURuR7r2TIvIrclNj1KS493ORxuRy3jY4F6xGNe8y0gPeFqvmCUWC4L/B+DUHOFVuU/KgAAAABJRU5ErkJggg=='
personalAvatarName = 'my_avatar.png'
_ = require 'underscore'

avatarNameMaping = (uid)->
	return uid+'.png'

module.exports = (options,imports,register)->
	events = imports['events'].namespaced("avatar_manager")
	server = imports['server']
	avatar_path = path.join(options.var_dir,avatar_dir)
	avatar_base_url = server.url_prefix.core_assets+'/avatar'
	api=
		createAvatarForUid:(uid,avatar_base64)->
			return if _.isUndefined(avatar_base64) or avatar_base64==null or avatar_base64==""
			fs.writeFile path.join(avatar_path,avatarNameMaping(uid)),avatar_base64,{encoding:'base64'},(err)->
				return console.log err if err?
				events.emit 'avatar:ready',uid,"#{avatar_base_url}/#{uid}"
		getPersonalAvatar:->
			pa = path.join(avatar_path,personalAvatarName)
			if fs.existsSync pa
				return fs.readFileSync pa,{encoding:'base64'}
			else
				return default_base64
	###
		HTTP API
	###

	express_app = server.app
	express_app.get "#{avatar_base_url}/:uid?",(req,res)->
		uid = req.param('uid')
		final_path = default_avatar
		if _.isUndefined(uid)
			pa = path.join(avatar_path,personalAvatarName)
			final_path = pa if fs.existsSync pa
		else
			p = path.join(avatar_path,avatarNameMaping(uid))
			final_path=p if fs.existsSync(p)
		fs.createReadStream(final_path).pipe(res)

	fs.mkdirSync avatar_path if not fs.existsSync(avatar_path)
	
	register null,{avatar_manager:api}